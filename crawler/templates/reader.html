{% extends 'index.html' %}
{% load static %}

{% block title %}
Reader
{% endblock %}

{% block content %}
<form method="POST">
	{% csrf_token %}
	<input type="hidden" id="id" name="id" value="{{paper.id}}">
	<div class="page-inner">
		<div class="row">
			<div class="col-md-4">
				<div class="card">
					<div class="card-header">
						<center>
						<ul class="nav nav-pills nav-secondary nav-pills-no-bd nav-sm" id="pills-tab" role="tablist">
							<li class="nav-item submenu">
								<button id="btn-start-recording" class="nav-link active show">Start Recording</button>
							</li>
							<li class="nav-item submenu">
								<button id="btn-stop-recording" disabled class="nav-link active show">Stop Recording</button>
							</li>
						</ul>
						</center>
					</div>
					<div class="card-body">
						<center><video controls autoplay playsinline></video></center>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<div class="card-head-row">
							<div class="card-title">Tags</div>
							<div class="card-tools">
								<ul class="nav nav-pills nav-secondary nav-pills-no-bd nav-sm" id="pills-tab" role="tablist">
									<li class="nav-item submenu">
										<input class="nav-link active show" type="submit" value="Submit">
									</li>
								</ul>
							</div>
						</div>
					</div>
					<div class="card-body">
						<div><b>{% for ta in tags %}<a href="/crawler/tag?tag={{ta.tag.text}}">{{ta.tag.text}}</a>, {%endfor%}</b></div>
						<div class="form-group" id="tags"></div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<div class="card-head-row">
							<div class="card-title">{{paper.title}}</div>
							<div class="card-tools">
								<ul class="nav nav-pills nav-secondary nav-pills-no-bd nav-sm" id="pills-tab" role="tablist">
									<li class="nav-item submenu">
										<a href="/crawler/reader?id={{paper.id|add:-1}}" class="nav-link">Previous</a>
									</li>
									<li class="nav-item submenu">
										<a href="/crawler/reader?id={{paper.id|add:1}}" class="nav-link">Next</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
					<div class="card-body">
						<div><p><b>Authors: {%for a in paper.authors.all%}{{a.name}} {%endfor%}</b></p></div>
						<div><p><b>Network score: {{ maxNetworkSize }}</b></p></div>
						<div><b>Abstract:</b>{{paper.abstract}}</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<div class="card-title">Comments</div>
					</div>
					<div class="card-body">
						<ol class="activity-feed" id="comments">
							{% for c in comments %}
							<li class="feed-item feed-item-secondary">
								<time class="date" datetime="9-25">{{c.updated_at}}</time>
								<span class="text">{{c.text}}</span>
							</li>
							{% endfor %}
						</ol>

						<div class="form-group">
							<input type="text" class="form-control form-control" id="comment" name="comment" placeholder="Your comments">
						</div>
					</div>
				</div>	
			</div>
			<div class="col-md-8">
				<div class="card">
					<div class="card-body">
						<div id="example1"></div>		
					</div>
				</div>
				<div class="card">
					<div class="card-body">
						<div id="words"></div>
					</div>
				</div>
				<div class="card">
					<div class="card-header">
						<div class="card-head-row">
							<div class="card-title">References</div>
							<div class="card-tools"></div>
						</div>
					</div>

					<div class="card-body">
					</div>
				</div>
			</div>
		</div>
	</div>
</form>
{% endblock %}

{% block js %}
	<script src="{% static 'js/plugin/taggle.js/example/js/taggle.min.js' %}"></script>
	<!-- web streams API polyfill to support Firefox -->
    	<script src="https://unpkg.com/@mattiasbuelens/web-streams-polyfill/dist/polyfill.min.js"></script>

    	<!-- ../libs/DBML.js to fix video seeking issues -->
    	<script src="https://www.webrtc-experiment.com/EBML.js"></script>

    	<!-- for Edge/FF/Chrome/Opera/etc. getUserMedia support -->
    	<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    	<script src="https://www.webrtc-experiment.com/DetectRTC.js"> </script>

    	<!-- video element -->
    	<link href="https://www.webrtc-experiment.com/getHTMLMediaElement.css" rel="stylesheet">
    	<script src="https://www.webrtc-experiment.com/getHTMLMediaElement.js"></script>
	<script type="text/javascript">
		jQuery.curCSS = jQuery.css;
		PDFObject.embed("/static/paper{{paper.id}}.pdf", "#example1");
		var tagger = new Taggle('tags', {
			tags: [],
    			duplicateTagClass: 'bounce'
		});
		var container = tagger.getContainer();
		var input = tagger.getInput();

		$(input).autocomplete({
    			source: [{% for v in vocab %}'{{v.text}}',{% endfor %}], // See jQuery UI documentaton for options
   			appendTo: container,
   		 	position: { at: "left bottom", of: container },
    			select: function(event, data) {
        			event.preventDefault();
        			//Add the tag if user clicks
        			if (event.which === 1) {
            				tagger.add(data.item.value);
        			}
    			}
		});
		var data = [{% for word in words %}{"word": "{{ word.word }}", "count": {{ word.count}}},{% endfor %}];
		$(function(){
 		 	var countMax = d3.max(data, function(d){ return d.count} );
  			var sizeScale = d3.scaleLinear().domain([0, countMax]).range([10, 100])
    			d3.layout.cloud().size([750, 300])
        			.words(data.map(function(d) {
                			return {text: d.word, size: sizeScale(d.count)}; 
            				})
        			) 
				.rotate(function() { return (~~(Math.random() * 6) - 3) * 30; })
				.font("Impact")ã€€
				.fontSize(function(d) { return d.size; })
        			.on("end", draw)
        			.start();
    
		   	function draw(words) {
        			d3.select("#words").append("svg")
            			.attr("width", "100%")
           			.attr("height", 300)
				.attr("class", "ui fluid image") // style using semantic ui
        			.attr("viewBox", "0 0 750 300")  // ViewBox : x, y, width, height
            			.append("g")
            			.attr("transform", "translate(375,150)")
      				.selectAll("text")
        			.data(words)
      				.enter().append("text")
        			.style("font-size", function(d) { return d.size + "px"; })
        			.style("font-family", "Impact")
        			.style("fill", function(d, i) { return d3.schemeCategory10[i % 10]; })
        			.attr("text-anchor", "middle")
        			.attr("transform", function(d) {
          				return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        			})
        			.text(function(d) { return d.text; });
   			}    
 
		}());
		$(document).ready(function() {
			// Check whether the browser is Safari or not
			var ua = navigator.userAgent.toLowerCase();
			if (ua.indexOf('safari') != -1 && ua.indexOf('chrome') < 0) {
				alert("WebRTC does not work well with Safari, switching to Chrome or Opera fo better experience");
			}
			$('#comment').keypress(function (e) {
  			if (e.which == 13) {
    				$('form').submit();
    				return false; 
			}});
			//Webcam.attach('#camera');
			var video = document.querySelector('video');
			function captureCamera(callback) {
				var constraints = {
  					video: {
    						width: { min: 320, ideal: 320 },
    						height: { min: 240 },
    						frameRate: 60,
    						facingMode: "user",
  					}
				};
				
    				navigator.mediaDevices.getUserMedia({ audio: true, video: true }).then(function(camera) {
        				callback(camera);
    				}).catch(function(error) {
        				alert('Unable to capture your camera. Please check console logs.');
        				console.error(error);
    				});
			}
			function stopRecordingCallback() {
    				video.src = video.srcObject = null;
    				video.muted = false;
    				video.volume = 1;
    				video.src = URL.createObjectURL(recorder.getBlob());
				let blob = recorder.getBlob();
				invokeSaveAsDialog(blob);
				recorder.camera.stop();
    				recorder.destroy();
    				recorder = null;
			}
			var recorder; // globally accessible
			document.getElementById('btn-start-recording').onclick = function() {
    				this.disabled = true;
    				captureCamera(function(camera) {
        			video.muted = true;
        			video.volume = 0;
        			video.srcObject = camera;
        			recorder = RecordRTC(camera, {
            				type: 'video',
					mimeType: 'video/mp4',
					recorderType: WhammyRecorder,
        			});
        			recorder.startRecording();
        			// release camera on stopRecording
        			recorder.camera = camera;
        			document.getElementById('btn-stop-recording').disabled = false;
    				});
			};
			document.getElementById('btn-stop-recording').onclick = function() {
    				this.disabled = true;
    				recorder.stopRecording(stopRecordingCallback);
				$("#btn-start-recording").disabled =false;
			};
		});
	</script>
{% endblock %}

{% block css %}
<style>
	.recordrtc button {
            font-size: inherit;
        }
        .recordrtc button, .recordrtc select {
            vertical-align: middle;
            line-height: 1;
            padding: 2px 5px;
            height: auto;
            font-size: inherit;
            margin: 0;
        }
        .recordrtc, .recordrtc .header {
            display: block;
            text-align: center;
            padding-top: 0;
        }
        .recordrtc video, .recordrtc img {
            max-width: 100%!important;
            vertical-align: top;
        }
        .recordrtc audio {
            vertical-align: bottom;
        }
        .recordrtc option[disabled] {
            display: none;
        }
        .recordrtc select {
            font-size: 17px;
        }
	div#video {
  		width: calc(100% + 20px);
	}

	video {
 	 	--width: 90%;
  		width: var(--width);
  		height: calc(var(--width) * 0.75);
  		margin: 0 0 10px 0;
	}
</style>
{% endblock %}
